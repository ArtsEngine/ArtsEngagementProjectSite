<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>Structural Topic Model Workflow</title>
  <meta name="description" content="        Structural Topic Model Workflow    Order of operations:Preliminary structural topic model (STM) created with a number of topics decided by spectral i...">

  <link rel="canonical" href="http://artsengagementproject.site//analysis/stm-workflow.html">
  <link rel="alternate" type="application/rss+xml" title="The Arts Engagement Project at The University of Michigan" href="http://artsengagementproject.site//feed.xml">

  <meta property="og:url"         content="http://artsengagementproject.site//analysis/stm-workflow.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Structural Topic Model Workflow" />
<meta property="og:description" content="        Structural Topic Model Workflow    Order of operations:Preliminary structural topic model (STM) created with a number of topics decided by spectral i..." />
<meta property="og:image"       content="http://artsengagementproject.site//images/logo/logo.png" />

<meta name="twitter:card" content="summary">


  <script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": "http://artsengagementproject.site//analysis/stm-workflow.html",
  "headline": "Structural Topic Model Workflow",
  "datePublished": "2020-03-25T15:49:37-04:00",
  "dateModified": "2020-03-25T15:49:37-04:00",
  "description": "        Structural Topic Model Workflow    Order of operations:Preliminary structural topic model (STM) created with a number of topics decided by spectral i...",
  "author": {
    "@type": "Person",
    "name": "Gabriel Harp"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Data 100 at UC Berkeley",
    "logo": {
      "@type": "ImageObject",
      "url": "http://artsengagementproject.site/",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "http://artsengagementproject.site/",
    "height": 60,
    "width": 60
  }
}

  </script>
  <link rel="stylesheet" href="/assets/css/styles.css">

  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/images/logo/favicon.ico">

  <!-- MathJax Config -->
  <!-- Allow inline math using $ and automatically break long math lines -->
<!-- (mostly) copied from nbconvert configuration -->
<!-- https://github.com/jupyter/nbconvert/blob/master/nbconvert/templates/html/mathjax.tpl -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    // Center justify equations in code and markdown cells. Elsewhere
    // we use CSS to left justify single line equations in code cells.
    displayAlign: 'center',
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}},
        linebreaks: { automatic: true },
    },
    
});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML' async></script>


  <!-- DOM updating function -->
  <script src="/assets/js/page/dom-update.js"></script>

  <!-- Selectors for elements on the page -->
  <script src="/assets/js/page/documentSelectors.js"></script>

  <!-- Define some javascript variables that will be useful in other javascript -->
  <script>
    const site_basename = '';
  </script>

  <!-- Add AnchorJS to let headers be linked -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js" async></script>
  <script src="/assets/js/page/anchors.js" async></script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js" async></script>
  <meta name="turbolinks-cache-control" content="no-cache">

  <!-- Load nbinteract for widgets -->
  

  <!-- Load Thebelab for interactive widgets -->
  <!-- Include Thebelab for interactive code if it's enabled -->



  <!-- Load the auto-generating TOC (non-async otherwise the TOC won't load w/ turbolinks) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.8.1/tocbot.min.js" async></script>
  <script src="/assets/js/page/tocbot.js"></script>

  <!-- Google analytics -->
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



  <!-- Clipboard copy button -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script>

  <!-- Load custom website scripts -->
  <script src="/assets/js/scripts.js" async></script>

  <!-- Load custom user CSS and JS  -->
  <script src="/assets/custom/custom.js" async></script>
  <link rel="stylesheet" href="/assets/custom/custom.css">

  <!-- Update interact links w/ REST param, is defined in includes so we can use templates -->
  

  <!-- Lunr search code - will only be executed on the /search page -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.6/lunr.min.js" async></script>
  <script>var initQuery = function() {
  // See if we have a search box
  var searchInput = document.querySelector('input#lunr_search');
  if (searchInput === null) {
    return;
  }

  // Function to parse our lunr cache
  var idx = lunr(function () {
    this.field('title')
    this.field('excerpt')
    this.field('categories')
    this.field('tags')
    this.ref('id')

    this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        title: store[item].title,
        excerpt: store[item].excerpt,
        categories: store[item].categories,
        tags: store[item].tags,
        id: item
      })
    }
  });

  // Run search upon keyup
  searchInput.addEventListener('keyup', function () {
    var resultdiv = document.querySelector('#results');
    var query = document.querySelector("input#lunr_search").value.toLowerCase();
    var result =
      idx.query(function (q) {
        query.split(lunr.tokenizer.separator).forEach(function (term) {
          q.term(term, { boost: 100 })
          if(query.lastIndexOf(" ") != query.length-1){
            q.term(term, {  usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 })
          }
          if (term != ""){
            q.term(term, {  usePipeline: false, editDistance: 1, boost: 1 })
          }
        })
      });

      // Empty the results div
      while (resultdiv.firstChild) {
        resultdiv.removeChild(resultdiv.firstChild);
      }

    resultdiv.insertAdjacentHTML('afterbegin', '<p class="results__found">'+result.length+' Result(s) found</p>');
    for (var item in result) {
      var ref = result[item].ref;
      if(store[ref].teaser){
        var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<div class="archive__item-teaser">'+
                '<img src="'+store[ref].teaser+'" alt="">'+
              '</div>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      else{
    	  var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      resultdiv.insertAdjacentHTML('beforeend', searchitem);
    }
  });
};

initFunction(initQuery);
</script>

  <!-- Load JS that depends on site variables -->
  <script src="/assets/js/page/copy-button.js" async></script>

  <!-- Hide cell code -->
  <script src="/assets/js/page/hide-cell.js" async></script>

  <!-- Printing the screen -->
  <!-- Include nbinteract for interactive widgets -->
<script src="https://printjs-4de6.kxcdn.com/print.min.js" async></script>
<script>
printContent = () => {
    // MathJax displays a second version of any math for assistive devices etc.
    // This prevents double-rendering in the PDF output.
    var ignoreAssistList = [];
    assistives = document.querySelectorAll('.MathJax_Display span.MJX_Assistive_MathML').forEach((element, index) => {
        var thisId = 'MathJax-assistive-' + index.toString();
        element.setAttribute('id', thisId);
        ignoreAssistList.push(thisId)
    });

    // Print the actual content object
    printJS({
        printable: 'textbook_content',
        type: 'html',
        css: "/assets/css/styles.css",
        style: "#textbook_content {padding-top: 40px};",
        scanStyles: false,
        targetStyles: ["*"],
        ignoreElements: ignoreAssistList,
        documentTitle: "Made with Jupyter Book"
    })
};

initPrint = () => {
    document.querySelector('#interact-button-print').addEventListener('click', printContent)
}

initFunction(initPrint)
</script>

</head>

  <body>
    <!-- Include the ThebeLab config so it gets reloaded on each page -->
    <script type="text/x-thebe-config">{
    requestKernel: true,
    binderOptions: {
    repo: "YOUR-ORG/YOUR-REPO",
    ref: "gh-pages",
    },
    codeMirrorConfig: {
    theme: "abcdef",
    mode: ""
    },
    kernelOptions: {
    kernelName: "ir",
    path: "content/analysis"
    }
}
</script>

    <!-- .js-show-sidebar shows sidebar by default -->
    <div id="js-textbook" class="c-textbook js-show-sidebar">
      



<nav id="js-sidebar" class="c-textbook__sidebar">
  <a href="https://artsengagementproject.site"><img src="/images/logo/logo.png" class="textbook_logo" id="sidebar-logo" alt="textbook logo" data-turbolinks-permanent/></a>
  <h2 class="c-sidebar__title">The Arts Engagement Project at The University of Michigan</h2>
  <ul class="c-sidebar__chapters">
    
      
      

      
      
      
      

      
      
      <li class="c-sidebar__chapter" data-url="/intro">
        <a class="c-sidebar__entry"
          href="/intro.html"
        >
          
          Overview
        </a>
      </li>

      
      

      

      
      

      
        

        

        <ul class="c-sidebar__sections">
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/overview/background">
              <a class="c-sidebar__entry"
                href="/overview/background.html"
              >
                
                Background
              </a>
            </li>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/overview/studydesign">
              <a class="c-sidebar__entry"
                href="/overview/studydesign.html"
              >
                
                Study Design
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections u-hidden-visually'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/overview/studylogistics">
                  <a class="c-sidebar__entry"
                    href="/overview/studylogistics.html"
                  >
                    
                    Study Logistics
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/overview/surveydesign">
                  <a class="c-sidebar__entry"
                    href="/overview/surveydesign.html"
                  >
                    
                    Survey Design
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/overview/datacollection">
                  <a class="c-sidebar__entry"
                    href="/overview/datacollection.html"
                  >
                    
                    Data Collection
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/overview/datadescription">
                  <a class="c-sidebar__entry"
                    href="/overview/datadescription.html"
                  >
                    
                    Data Description
                  </a>
                </li>
              
              </ul>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/overview/presentations">
              <a class="c-sidebar__entry"
                href="/overview/presentations.html"
              >
                
                Presentations
              </a>
            </li>
            
            
          
        </ul>
      

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
      
      

      
      
      
      

      
      
      <li class="c-sidebar__chapter" data-url="/insights/insights">
        <a class="c-sidebar__entry"
          href="/insights/insights.html"
        >
          
          Insights
        </a>
      </li>

      
      

      

      
      

      
        

        

        <ul class="c-sidebar__sections">
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/insights/barriers">
              <a class="c-sidebar__entry"
                href="/insights/barriers.html"
              >
                
                Barriers to Involvement
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections u-hidden-visually'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/barriers/tree">
                  <a class="c-sidebar__entry"
                    href="/insights/barriers/tree.html"
                  >
                    
                    Barriers - Topic Tree
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/barriers/topics">
                  <a class="c-sidebar__entry"
                    href="/insights/barriers/topics.html"
                  >
                    
                    Barriers - Topic Descriptions
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/barriers/dimensions">
                  <a class="c-sidebar__entry"
                    href="/insights/barriers/dimensions.html"
                  >
                    
                    Barriers - Underlying Factors
                  </a>
                </li>
              
              </ul>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/insights/othergrowth">
              <a class="c-sidebar__entry"
                href="/insights/othergrowth.html"
              >
                
                Personal Growth
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections u-hidden-visually'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/othergrowth/tree">
                  <a class="c-sidebar__entry"
                    href="/insights/othergrowth/tree.html"
                  >
                    
                    Growth - Topic Tree
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/othergrowth/topics">
                  <a class="c-sidebar__entry"
                    href="/insights/othergrowth/topics.html"
                  >
                    
                    Growth - Topic Descriptions
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/othergrowth/dimensions">
                  <a class="c-sidebar__entry"
                    href="/insights/othergrowth/dimensions.html"
                  >
                    
                    Growth - Underlying Factors
                  </a>
                </li>
              
              </ul>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/insights/feel">
              <a class="c-sidebar__entry"
                href="/insights/feel.html"
              >
                
                Emotional Impact
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections u-hidden-visually'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/feel/tree">
                  <a class="c-sidebar__entry"
                    href="/insights/feel/tree.html"
                  >
                    
                    Emotional Impacts - Topic Tree
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/feel/topics">
                  <a class="c-sidebar__entry"
                    href="/insights/feel/topics.html"
                  >
                    
                    Emotional Impacts - Topic Descriptions
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/feel/dimensions">
                  <a class="c-sidebar__entry"
                    href="/insights/feel/dimensions.html"
                  >
                    
                    Emotional Impacts - Underlying Factors
                  </a>
                </li>
              
              </ul>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/insights/development">
              <a class="c-sidebar__entry"
                href="/insights/development.html"
              >
                
                Developmental Role
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections u-hidden-visually'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/development/tree">
                  <a class="c-sidebar__entry"
                    href="/insights/development/tree.html"
                  >
                    
                    Developmental Role - Topic Tree
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/development/topics">
                  <a class="c-sidebar__entry"
                    href="/insights/development/topics.html"
                  >
                    
                    Developmental Role - Topic Descriptions
                  </a>
                </li>
              
              </ul>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/insights/role">
              <a class="c-sidebar__entry"
                href="/insights/role.html"
              >
                
                College Experience
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections u-hidden-visually'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/role/tree">
                  <a class="c-sidebar__entry"
                    href="/insights/role/tree.html"
                  >
                    
                    College Experience - Topic Tree
                  </a>
                </li>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/insights/role/topics">
                  <a class="c-sidebar__entry"
                    href="/insights/role/topics.html"
                  >
                    
                    College Experience - Topic Descriptions
                  </a>
                </li>
              
              </ul>
            
            
          
        </ul>
      

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
      
      

      
      
      
      

      
      
      <li class="c-sidebar__chapter" data-url="/analysis/methods">
        <a class="c-sidebar__entry"
          href="/analysis/methods.html"
        >
          
          Analyses
        </a>
      </li>

      
      

      

      
      

      
        

        

        <ul class="c-sidebar__sections">
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/analysis/topics">
              <a class="c-sidebar__entry"
                href="/analysis/topics.html"
              >
                
                Topic Modeling and Interpretation
              </a>
            </li>
            
              
              <ul class='c-sidebar__subsections'>
              
                
                
                
                
                <li class="c-sidebar__subsection" data-url="/analysis/stm-workflow">
                  <a class="c-sidebar__entry"
                    href="/analysis/stm-workflow.html"
                  >
                    
                    Structural Topic Model Workflow
                  </a>
                </li>
              
              </ul>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/analysis/dictionaries">
              <a class="c-sidebar__entry"
                href="/analysis/dictionaries.html"
              >
                
                Dictionaries of Language Patterns
              </a>
            </li>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/analysis/pca-demographics">
              <a class="c-sidebar__entry"
                href="/analysis/pca-demographics.html"
              >
                
                Topic Prevalence Principal Components Analysis Against Demographics
              </a>
            </li>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/analysis/pca-density-plots">
              <a class="c-sidebar__entry"
                href="/analysis/pca-density-plots.html"
              >
                
                Topic Prevalence Principal Components and Demographics Density Plots
              </a>
            </li>
            
            
          
            
            

            
            
            
            

            <li class="c-sidebar__section" data-url="/analysis/demographics">
              <a class="c-sidebar__entry"
                href="/analysis/demographics.html"
              >
                
                Demographic Analysis
              </a>
            </li>
            
            
          
        </ul>
      

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
  </ul>
  <p class="sidebar_footer"><a href="../LICENSE.html">CC BY-SA 4.0</a> Powered by <a href="https://jupyterbook.org">Jupyter Book</a></p>
</nav>

      
      <div class="c-topbar" id="top-navbar">
  <!-- We show the sidebar by default so we use .is-active -->
  <div class="c-topbar__buttons">
    <button
      id="js-sidebar-toggle"
      class="hamburger hamburger--arrowalt is-active"
    >
      <span class="hamburger-box">
        <span class="hamburger-inner"></span>
      </span>
    </button>
    <div class="buttons">
<div class="download-buttons-dropdown">
    <button id="dropdown-button-trigger" class="interact-button"><img src="/assets/images/download-solid.svg" alt="Download" /></button>
    <div class="download-buttons">
        <a href="/content/analysis/stm-workflow.ipynb" download>
        <button id="interact-button-download" class="interact-button">.ipynb</button>
        </a>
        
        <a id="interact-button-print"><button id="interact-button-download" class="interact-button">.pdf</button></a>
    </div>
</div>


  
  
  
  


</div>

  </div>
  <!-- Empty sidebar placeholder that we'll auto-fill with javascript -->
  <aside class="sidebar__right">
    <header><h4 class="nav__title"><img src="/assets/images/list-solid.svg" alt="Search" />   On this page</h4></header>
    <nav class="onthispage">
    </nav>
  </aside>
  <a href="/search.html" class="topbar-right-button" id="search-button">
    <img src="/assets/images/search-solid.svg" alt="Search" />
  </a>
</div>

      <main class="c-textbook__page" tabindex="-1">
            <div class="c-textbook__content" id="textbook_content">
                  <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Structural Topic Model Workflow</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Order of operations:</p>
<ol>
<li>Preliminary structural topic model (STM) created with a number of topics decided by spectral initialization (k=0).</li>
<li>Clustering algorithms are run over the prelimary STMs' topic-prevalence by document matrix to find a number of topics that better fits the data.</li>
<li>STM data saved as JSON to be used with the visualization webapp.</li>
<li>Manual STM refinement.</li>
</ol>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># load libraries</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">stm</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">jsonlite</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">doMC</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">foreach</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">NbClust</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># load data</span>
<span class="nf">load</span><span class="p">(</span><span class="s">&#39;../data/tidy_questions_best.Rda&#39;</span><span class="p">)</span>
<span class="c1"># load helper script</span>
<span class="nf">source</span><span class="p">(</span><span class="s">&#39;../github/stmjson.R&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># Set number of cores to use on following computations</span>
<span class="nf">registerDoMC</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Preliminary-STM">Preliminary STM<a class="anchor-link" href="#Preliminary-STM"> </a></h2><p>Used to find baseline topic number using spectral initialization (K=0)</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># STM does not produce meaningful clusters for these questions and are best removed.</span>
<span class="n">questions</span> <span class="o">&lt;-</span> <span class="n">questions[</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">6</span><span class="p">)</span><span class="n">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">start</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">verbosity</span> <span class="o">&lt;-</span> <span class="kc">FALSE</span>

<span class="n">procs</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">textProcessor</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">questions[[n]][[1]]</span><span class="p">,</span>
                                                                  <span class="n">metadata</span> <span class="o">=</span> <span class="n">questions[[n]][2]</span><span class="p">,</span>
                                                                  <span class="n">customstopwords</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;art&#39;</span><span class="p">,</span><span class="s">&#39;arts&#39;</span><span class="p">),</span>
                                                                  <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">docs</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">prepDocuments</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">procs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span> 
                                                                 <span class="n">vocab</span> <span class="o">=</span> <span class="n">procs[[n]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">procs[[n]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span>
                                                                 <span class="n">lower.thresh</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">procs[[n]]</span><span class="o">$</span><span class="n">documents</span> <span class="o">%&gt;%</span>
                                                                                       <span class="n">length</span> <span class="o">&gt;</span> <span class="m">1000</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
                                                                 <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">prelim_stms</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">stm</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                                                               <span class="n">vocab</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> 
                                                               <span class="n">data</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">time_taken</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">time_taken</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea ">
<pre>Time difference of 2.267745 mins</pre>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="NbClust-Cluster-Analysis">NbClust Cluster Analysis<a class="anchor-link" href="#NbClust-Cluster-Analysis"> </a></h2><p>Used to find rough estimates of the best number of topics (clusters) for each question. The preliminary spectral initialization tends to overestimate the best number of topics for intuitive sense-making of the data as a whole, so clustering algorithms can then find topics likely to co-occur with each other and recommend a number of topics collapsing those groups into single topics. By using many clustering algorithms using varying techniques we can</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">pcas</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">prelim_stms</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">prcomp</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">prelim_stms[[n]]</span><span class="o">$</span><span class="n">theta</span><span class="p">),</span> <span class="n">scale.</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>

<span class="n">nbcs</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">pcas</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">NbClust</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">pcas[[n]]</span><span class="o">$</span><span class="n">x</span><span class="p">),</span>
                                                                     <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">prelim_stms[[n]]</span><span class="o">$</span><span class="n">settings</span><span class="o">$</span><span class="n">dim</span><span class="o">$</span><span class="n">K</span> <span class="o">-</span> <span class="m">5</span><span class="p">)),</span>
                                                       <span class="n">diss</span> <span class="o">=</span> <span class="nf">daisy</span><span class="p">(</span><span class="n">pcas[[n]]</span><span class="o">$</span><span class="n">x</span><span class="p">),</span>
                                                       <span class="n">distance</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span>
                                                       <span class="n">min.nc</span><span class="o">=</span><span class="m">3</span><span class="p">,</span>
                                                       <span class="n">max.nc</span><span class="o">=</span><span class="m">27</span><span class="p">,</span>
                                                       <span class="n">method</span><span class="o">=</span><span class="s">&#39;complete&#39;</span><span class="p">,</span>
                                                       <span class="n">index</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>*** : The Hubert index is a graphical method of determining the number of clusters.
                In the plot of Hubert index, we seek a significant knee that corresponds to a 
                significant increase of the value of the measure i.e the significant peak in Hubert
                index second differences plot. 
 
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../images/analysis/stm-workflow_8_1.png"
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>*** : The D index is a graphical method of determining the number of clusters. 
                In the plot of D index, we seek a significant knee (the significant peak in Dindex
                second differences plot) that corresponds to a significant increase of the value of
                the measure. 
 
******************************************************************* 
* Among all indices:                                                
* 9 proposed 3 as the best number of clusters 
* 2 proposed 4 as the best number of clusters 
* 2 proposed 7 as the best number of clusters 
* 1 proposed 12 as the best number of clusters 
* 3 proposed 13 as the best number of clusters 
* 1 proposed 19 as the best number of clusters 
* 1 proposed 20 as the best number of clusters 
* 1 proposed 21 as the best number of clusters 
* 2 proposed 22 as the best number of clusters 
* 1 proposed 25 as the best number of clusters 
* 1 proposed 27 as the best number of clusters 

                   ***** Conclusion *****                            
 
* According to the majority rule, the best number of clusters is  3 
 
 
******************************************************************* 
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../images/analysis/stm-workflow_8_3.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This code picks the best number of topics (clusters) for each dataset based on popular vote by the clustering algorithms (excluding the filtered methods). The methods filtered out consistently choose the lowest number of clusters in the provided range and are best not considered for our purposes.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">k_candidates</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="n">nbcs</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">num_clust</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">nbcs[[i]]</span><span class="o">$</span><span class="n">Best.nc</span> <span class="o">%&gt;%</span> <span class="n">t</span> <span class="o">%&gt;%</span> <span class="n">rownames</span><span class="p">,</span>
               <span class="n">nc</span><span class="o">=</span><span class="n">nbcs[[i]]</span><span class="o">$</span><span class="n">Best.nc</span> <span class="o">%&gt;%</span> <span class="n">t</span> <span class="o">%&gt;%</span> <span class="nf">as.data.frame</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">pull</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span> 
                    <span class="nf">filter</span><span class="p">(</span><span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Cindex&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;DB&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Silhouette&#39;</span> <span class="o">&amp;</span>
                           <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Duda&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;PseudoT2&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Beale&#39;</span> <span class="o">&amp;</span>
                           <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;McClain&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Hubert&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Dindex&#39;</span><span class="p">)</span>
    <span class="n">num_clust</span> <span class="o">%&lt;&gt;%</span> <span class="nf">pull</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">table</span> <span class="o">%&gt;%</span> <span class="n">data.frame</span> <span class="o">%&gt;%</span> <span class="nf">arrange</span><span class="p">(</span><span class="o">-</span><span class="n">Freq</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">pull</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="n">k_candidates</span> <span class="o">%&lt;&gt;%</span> <span class="nf">c</span><span class="p">(</span><span class="n">num_clust</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Improved-STMs">Improved STMs<a class="anchor-link" href="#Improved-STMs"> </a></h2><p>Using NbClust recommended numbers of topics (stored in the array k_candidates).</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">start</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">verbosity</span> <span class="o">&lt;-</span> <span class="kc">FALSE</span>

<span class="n">improved_stms</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">stm</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                                                                 <span class="n">vocab</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">k_candidates[n]</span><span class="p">,</span>
                                                                 <span class="n">data</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">time_taken</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">time_taken</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea ">
<pre>Time difference of 18.36213 secs</pre>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Outputting-STM-Data">Outputting STM Data<a class="anchor-link" href="#Outputting-STM-Data"> </a></h3><p>To be used with the webapp</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">question_names</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">question_names</span> <span class="o">%&lt;&gt;%</span> <span class="nf">c</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">questions[[i]][1]</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># set directory to save to</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s">&#39;./&#39;</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="m">0</span>
<span class="nf">for </span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nf">while</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">FALSE</span>
        <span class="nf">tryCatch</span><span class="p">({</span>
          <span class="nf">create_json</span><span class="p">(</span>
                <span class="n">stm</span> <span class="o">=</span> <span class="n">improved_stms[[n]]</span><span class="p">,</span>
                <span class="n">documents_raw</span> <span class="o">=</span> <span class="n">questions[[n]][question_names[n]]</span> <span class="o">%&gt;%</span> <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">procs[[n]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                                   <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">docs[[n]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                                   <span class="n">pull</span><span class="p">,</span>
                <span class="n">documents_matrix</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">question_names[[n]]</span><span class="p">,</span>
                <span class="n">title</span> <span class="o">=</span> <span class="nf">names</span><span class="p">(</span><span class="n">questions[n]</span><span class="p">),</span>
                <span class="n">clustering_thresh</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="bp">T</span><span class="p">,</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
            <span class="p">)</span>
        <span class="p">},</span> <span class="n">error</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">TRUE</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">+</span> <span class="m">0.1</span>
        <span class="p">})</span>
        <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="n">break</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Performing hierarchical topic clustering ... 
Generating JSON representation of the model ... 
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="STM-Refinement">STM Refinement<a class="anchor-link" href="#STM-Refinement"> </a></h2><p>Use this space to change the number of topics, lower.thresh, and stopwords of questions to try to make a qualitatively better model after having inspecting/comparing the model in the STM viewer webapp. A good place to start is looking at how well defined the no/none topic is.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Be sure to write down the question number, best number of topics, and custom stop words</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">i</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="c1"># question index number to modify</span>
<span class="n">ntopics</span> <span class="o">&lt;-</span> <span class="m">17</span>

<span class="n">procs[[i]]</span> <span class="o">&lt;-</span> <span class="nf">textProcessor</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">questions[[i]][[1]]</span><span class="p">,</span> 
              <span class="n">metadata</span> <span class="o">=</span> <span class="n">questions[[i]][2]</span><span class="p">,</span>
              <span class="n">customstopwords</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;art&#39;</span><span class="p">,</span><span class="s">&#39;arts&#39;</span><span class="p">))</span>

<span class="n">docs[[i]]</span> <span class="o">&lt;-</span> <span class="nf">prepDocuments</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">procs[[i]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
              <span class="n">vocab</span> <span class="o">=</span> <span class="n">procs[[i]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span>
              <span class="n">meta</span> <span class="o">=</span> <span class="n">procs[[i]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span>
              <span class="n">lower.thresh</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">procs[[i]]</span><span class="o">$</span><span class="n">documents</span> <span class="o">%&gt;%</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="m">1000</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>

<span class="n">start</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">stmobj</span> <span class="o">&lt;-</span> <span class="nf">stm</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">docs[[i]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                <span class="n">vocab</span> <span class="o">=</span> <span class="n">docs[[i]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span>
                <span class="n">K</span> <span class="o">=</span> <span class="n">ntopics</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">docs[[i]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">F</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Building corpus... 
Converting to Lower Case... 
Removing punctuation... 
Removing stopwords... 
Remove Custom Stopwords...
Removing numbers... 
Stemming... 
Creating Output... 
Removing 1571 of 2088 terms (2184 of 10266 tokens) due to frequency 
Removing 12 Documents with No Words 
Your corpus now has 1043 documents, 517 terms and 8082 tokens.Time difference of 4.885605 secs
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># set directory to save to</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s">&#39;./&#39;</span>
<span class="c1"># names the json data.json</span>
<span class="n">datajson</span> <span class="o">=</span> <span class="kc">TRUE</span>

<span class="c1"># comment out one of the following 2 lines</span>
<span class="n">labels</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="c1"># labels &lt;- read_json(&#39;labels/sr_othergrowth_labels.json&#39;)</span>

<span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">labels</span><span class="o">$</span><span class="n">topics</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
    <span class="n">labels</span><span class="o">$</span><span class="n">clusters</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="p">}</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="m">0</span>
<span class="nf">while</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">err</span> <span class="o">=</span> <span class="kc">FALSE</span>
    <span class="nf">tryCatch</span><span class="p">({</span>
      <span class="nf">create_json</span><span class="p">(</span>
        <span class="n">stm</span> <span class="o">=</span> <span class="n">stmobj</span><span class="p">,</span>
        <span class="n">documents_raw</span> <span class="o">=</span> <span class="n">questions[[i]][question_names[i]]</span> <span class="o">%&gt;%</span> <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">procs[[i]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                           <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">docs[[i]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                           <span class="n">pull</span><span class="p">,</span>
        <span class="n">documents_matrix</span> <span class="o">=</span> <span class="n">docs[[i]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="n">question_names[[i]]</span><span class="p">,</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nf">names</span><span class="p">(</span><span class="n">questions[i]</span><span class="p">),</span>
        <span class="n">clustering_thresh</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="n">instant</span> <span class="o">=</span> <span class="n">datajson</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">T</span><span class="p">,</span>
        <span class="n">topic_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">$</span><span class="n">topics</span><span class="p">,</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">$</span><span class="n">clusters</span><span class="p">,</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="p">)},</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">TRUE</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">+</span> <span class="m">0.1</span>
    <span class="p">})</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="n">break</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Performing hierarchical topic clustering ... 
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

 


    </main>
    
            </div>
            <div class="c-textbook__footer" id="textbook_footer">
              
<nav class="c-page__nav">
  
    
    

    <a id="js-page__nav__prev" class="c-page__nav__prev" href="/analysis/topics.html">
      〈 <span class="u-margin-right-tiny"></span> Topic Modeling and Interpretation
    </a>
  

  
    

    
    <a id="js-page__nav__next" class="c-page__nav__next" href="/analysis/dictionaries.html">
      Dictionaries of Language Patterns <span class="u-margin-right-tiny"></span> 〉
    </a>
  
</nav>

              <footer>
  <p class="footer">This page is created and maintained by <a href="https://github.com/gharp">Gabriel Harp</a></p>
</footer>

            </div>

        </div>
      </main>
    </div>
  </body>
</html>
