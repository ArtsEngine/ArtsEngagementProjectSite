---
interact_link: content/analysis/stm-workflow.ipynb
kernel_name: ir
kernel_path: content/analysis
has_widgets: false
title: |-
  Structural Topic Model Workflow
pagenum: 29
prev_page:
  url: /analysis/topics.html
next_page:
  url: /analysis/dictionaries.html
suffix: .ipynb
search: topics stm topic best model clustering algorithms data used using preliminary spectral initialization webapp clusters structural k stms better refinement nbclust question filtered methods workflow order operations created decided run prelimary prevalence document matrix fits saved json visualization manual baseline cluster analysis rough estimates tends overestimate intuitive sense making whole likely co occur recommend collapsing those groups into single varying techniques code picks dataset based popular vote excluding consistently choose lowest provided range not considered our purposes improved recommended numbers stored array kcandidates outputting space change lower thresh stopwords questions try qualitatively after having inspecting comparing viewer good place start

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Structural Topic Model Workflow</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Order of operations:</p>
<ol>
<li>Preliminary structural topic model (STM) created with a number of topics decided by spectral initialization (k=0).</li>
<li>Clustering algorithms are run over the prelimary STMs' topic-prevalence by document matrix to find a number of topics that better fits the data.</li>
<li>STM data saved as JSON to be used with the visualization webapp.</li>
<li>Manual STM refinement.</li>
</ol>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># load libraries</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">stm</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">jsonlite</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">doMC</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">foreach</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">NbClust</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># load data</span>
<span class="nf">load</span><span class="p">(</span><span class="s">&#39;../data/tidy_questions_best.Rda&#39;</span><span class="p">)</span>
<span class="c1"># load helper script</span>
<span class="nf">source</span><span class="p">(</span><span class="s">&#39;../github/stmjson.R&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># Set number of cores to use on following computations</span>
<span class="nf">registerDoMC</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Preliminary-STM">Preliminary STM<a class="anchor-link" href="#Preliminary-STM"> </a></h2><p>Used to find baseline topic number using spectral initialization (K=0)</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># STM does not produce meaningful clusters for these questions and are best removed.</span>
<span class="n">questions</span> <span class="o">&lt;-</span> <span class="n">questions[</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">6</span><span class="p">)</span><span class="n">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">start</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">verbosity</span> <span class="o">&lt;-</span> <span class="kc">FALSE</span>

<span class="n">procs</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">textProcessor</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">questions[[n]][[1]]</span><span class="p">,</span>
                                                                  <span class="n">metadata</span> <span class="o">=</span> <span class="n">questions[[n]][2]</span><span class="p">,</span>
                                                                  <span class="n">customstopwords</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;art&#39;</span><span class="p">,</span><span class="s">&#39;arts&#39;</span><span class="p">),</span>
                                                                  <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">docs</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">prepDocuments</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">procs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span> 
                                                                 <span class="n">vocab</span> <span class="o">=</span> <span class="n">procs[[n]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">procs[[n]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span>
                                                                 <span class="n">lower.thresh</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">procs[[n]]</span><span class="o">$</span><span class="n">documents</span> <span class="o">%&gt;%</span>
                                                                                       <span class="n">length</span> <span class="o">&gt;</span> <span class="m">1000</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
                                                                 <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">prelim_stms</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">stm</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                                                               <span class="n">vocab</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> 
                                                               <span class="n">data</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">time_taken</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">time_taken</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea ">
<pre>Time difference of 2.267745 mins</pre>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="NbClust-Cluster-Analysis">NbClust Cluster Analysis<a class="anchor-link" href="#NbClust-Cluster-Analysis"> </a></h2><p>Used to find rough estimates of the best number of topics (clusters) for each question. The preliminary spectral initialization tends to overestimate the best number of topics for intuitive sense-making of the data as a whole, so clustering algorithms can then find topics likely to co-occur with each other and recommend a number of topics collapsing those groups into single topics. By using many clustering algorithms using varying techniques we can</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">pcas</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">prelim_stms</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">prcomp</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">prelim_stms[[n]]</span><span class="o">$</span><span class="n">theta</span><span class="p">),</span> <span class="n">scale.</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>

<span class="n">nbcs</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">pcas</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">NbClust</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">pcas[[n]]</span><span class="o">$</span><span class="n">x</span><span class="p">),</span>
                                                                     <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">prelim_stms[[n]]</span><span class="o">$</span><span class="n">settings</span><span class="o">$</span><span class="n">dim</span><span class="o">$</span><span class="n">K</span> <span class="o">-</span> <span class="m">5</span><span class="p">)),</span>
                                                       <span class="n">diss</span> <span class="o">=</span> <span class="nf">daisy</span><span class="p">(</span><span class="n">pcas[[n]]</span><span class="o">$</span><span class="n">x</span><span class="p">),</span>
                                                       <span class="n">distance</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span>
                                                       <span class="n">min.nc</span><span class="o">=</span><span class="m">3</span><span class="p">,</span>
                                                       <span class="n">max.nc</span><span class="o">=</span><span class="m">27</span><span class="p">,</span>
                                                       <span class="n">method</span><span class="o">=</span><span class="s">&#39;complete&#39;</span><span class="p">,</span>
                                                       <span class="n">index</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>*** : The Hubert index is a graphical method of determining the number of clusters.
                In the plot of Hubert index, we seek a significant knee that corresponds to a 
                significant increase of the value of the measure i.e the significant peak in Hubert
                index second differences plot. 
 
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../images/analysis/stm-workflow_8_1.png"
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>*** : The D index is a graphical method of determining the number of clusters. 
                In the plot of D index, we seek a significant knee (the significant peak in Dindex
                second differences plot) that corresponds to a significant increase of the value of
                the measure. 
 
******************************************************************* 
* Among all indices:                                                
* 9 proposed 3 as the best number of clusters 
* 2 proposed 4 as the best number of clusters 
* 2 proposed 7 as the best number of clusters 
* 1 proposed 12 as the best number of clusters 
* 3 proposed 13 as the best number of clusters 
* 1 proposed 19 as the best number of clusters 
* 1 proposed 20 as the best number of clusters 
* 1 proposed 21 as the best number of clusters 
* 2 proposed 22 as the best number of clusters 
* 1 proposed 25 as the best number of clusters 
* 1 proposed 27 as the best number of clusters 

                   ***** Conclusion *****                            
 
* According to the majority rule, the best number of clusters is  3 
 
 
******************************************************************* 
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../images/analysis/stm-workflow_8_3.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This code picks the best number of topics (clusters) for each dataset based on popular vote by the clustering algorithms (excluding the filtered methods). The methods filtered out consistently choose the lowest number of clusters in the provided range and are best not considered for our purposes.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">k_candidates</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="n">nbcs</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">num_clust</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">nbcs[[i]]</span><span class="o">$</span><span class="n">Best.nc</span> <span class="o">%&gt;%</span> <span class="n">t</span> <span class="o">%&gt;%</span> <span class="n">rownames</span><span class="p">,</span>
               <span class="n">nc</span><span class="o">=</span><span class="n">nbcs[[i]]</span><span class="o">$</span><span class="n">Best.nc</span> <span class="o">%&gt;%</span> <span class="n">t</span> <span class="o">%&gt;%</span> <span class="nf">as.data.frame</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">pull</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span> 
                    <span class="nf">filter</span><span class="p">(</span><span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Cindex&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;DB&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Silhouette&#39;</span> <span class="o">&amp;</span>
                           <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Duda&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;PseudoT2&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Beale&#39;</span> <span class="o">&amp;</span>
                           <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;McClain&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Hubert&#39;</span> <span class="o">&amp;</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;Dindex&#39;</span><span class="p">)</span>
    <span class="n">num_clust</span> <span class="o">%&lt;&gt;%</span> <span class="nf">pull</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">table</span> <span class="o">%&gt;%</span> <span class="n">data.frame</span> <span class="o">%&gt;%</span> <span class="nf">arrange</span><span class="p">(</span><span class="o">-</span><span class="n">Freq</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">pull</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="n">k_candidates</span> <span class="o">%&lt;&gt;%</span> <span class="nf">c</span><span class="p">(</span><span class="n">num_clust</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Improved-STMs">Improved STMs<a class="anchor-link" href="#Improved-STMs"> </a></h2><p>Using NbClust recommended numbers of topics (stored in the array k_candidates).</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">start</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">verbosity</span> <span class="o">&lt;-</span> <span class="kc">FALSE</span>

<span class="n">improved_stms</span> <span class="o">&lt;-</span> <span class="nf">foreach</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="o">%dopar%</span> <span class="nf">stm</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                                                                 <span class="n">vocab</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">k_candidates[n]</span><span class="p">,</span>
                                                                 <span class="n">data</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

<span class="n">time_taken</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">time_taken</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea ">
<pre>Time difference of 18.36213 secs</pre>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Outputting-STM-Data">Outputting STM Data<a class="anchor-link" href="#Outputting-STM-Data"> </a></h3><p>To be used with the webapp</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">question_names</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">question_names</span> <span class="o">%&lt;&gt;%</span> <span class="nf">c</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">questions[[i]][1]</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># set directory to save to</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s">&#39;./&#39;</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="m">0</span>
<span class="nf">for </span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">questions</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nf">while</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">FALSE</span>
        <span class="nf">tryCatch</span><span class="p">({</span>
          <span class="nf">create_json</span><span class="p">(</span>
                <span class="n">stm</span> <span class="o">=</span> <span class="n">improved_stms[[n]]</span><span class="p">,</span>
                <span class="n">documents_raw</span> <span class="o">=</span> <span class="n">questions[[n]][question_names[n]]</span> <span class="o">%&gt;%</span> <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">procs[[n]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                                   <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">docs[[n]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                                   <span class="n">pull</span><span class="p">,</span>
                <span class="n">documents_matrix</span> <span class="o">=</span> <span class="n">docs[[n]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">question_names[[n]]</span><span class="p">,</span>
                <span class="n">title</span> <span class="o">=</span> <span class="nf">names</span><span class="p">(</span><span class="n">questions[n]</span><span class="p">),</span>
                <span class="n">clustering_thresh</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="bp">T</span><span class="p">,</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
            <span class="p">)</span>
        <span class="p">},</span> <span class="n">error</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">TRUE</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">+</span> <span class="m">0.1</span>
        <span class="p">})</span>
        <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="n">break</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Performing hierarchical topic clustering ... 
Generating JSON representation of the model ... 
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="STM-Refinement">STM Refinement<a class="anchor-link" href="#STM-Refinement"> </a></h2><p>Use this space to change the number of topics, lower.thresh, and stopwords of questions to try to make a qualitatively better model after having inspecting/comparing the model in the STM viewer webapp. A good place to start is looking at how well defined the no/none topic is.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Be sure to write down the question number, best number of topics, and custom stop words</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">i</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="c1"># question index number to modify</span>
<span class="n">ntopics</span> <span class="o">&lt;-</span> <span class="m">17</span>

<span class="n">procs[[i]]</span> <span class="o">&lt;-</span> <span class="nf">textProcessor</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">questions[[i]][[1]]</span><span class="p">,</span> 
              <span class="n">metadata</span> <span class="o">=</span> <span class="n">questions[[i]][2]</span><span class="p">,</span>
              <span class="n">customstopwords</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;art&#39;</span><span class="p">,</span><span class="s">&#39;arts&#39;</span><span class="p">))</span>

<span class="n">docs[[i]]</span> <span class="o">&lt;-</span> <span class="nf">prepDocuments</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">procs[[i]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
              <span class="n">vocab</span> <span class="o">=</span> <span class="n">procs[[i]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span>
              <span class="n">meta</span> <span class="o">=</span> <span class="n">procs[[i]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span>
              <span class="n">lower.thresh</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">procs[[i]]</span><span class="o">$</span><span class="n">documents</span> <span class="o">%&gt;%</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="m">1000</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>

<span class="n">start</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">stmobj</span> <span class="o">&lt;-</span> <span class="nf">stm</span><span class="p">(</span><span class="n">documents</span> <span class="o">=</span> <span class="n">docs[[i]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
                <span class="n">vocab</span> <span class="o">=</span> <span class="n">docs[[i]]</span><span class="o">$</span><span class="n">vocab</span><span class="p">,</span>
                <span class="n">K</span> <span class="o">=</span> <span class="n">ntopics</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">docs[[i]]</span><span class="o">$</span><span class="n">meta</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">F</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Building corpus... 
Converting to Lower Case... 
Removing punctuation... 
Removing stopwords... 
Remove Custom Stopwords...
Removing numbers... 
Stemming... 
Creating Output... 
Removing 1571 of 2088 terms (2184 of 10266 tokens) due to frequency 
Removing 12 Documents with No Words 
Your corpus now has 1043 documents, 517 terms and 8082 tokens.Time difference of 4.885605 secs
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># set directory to save to</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s">&#39;./&#39;</span>
<span class="c1"># names the json data.json</span>
<span class="n">datajson</span> <span class="o">=</span> <span class="kc">TRUE</span>

<span class="c1"># comment out one of the following 2 lines</span>
<span class="n">labels</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="c1"># labels &lt;- read_json(&#39;labels/sr_othergrowth_labels.json&#39;)</span>

<span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">labels</span><span class="o">$</span><span class="n">topics</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
    <span class="n">labels</span><span class="o">$</span><span class="n">clusters</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="p">}</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="m">0</span>
<span class="nf">while</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">err</span> <span class="o">=</span> <span class="kc">FALSE</span>
    <span class="nf">tryCatch</span><span class="p">({</span>
      <span class="nf">create_json</span><span class="p">(</span>
        <span class="n">stm</span> <span class="o">=</span> <span class="n">stmobj</span><span class="p">,</span>
        <span class="n">documents_raw</span> <span class="o">=</span> <span class="n">questions[[i]][question_names[i]]</span> <span class="o">%&gt;%</span> <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">procs[[i]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                           <span class="nf">slice</span><span class="p">(</span><span class="o">-</span><span class="n">docs[[i]]</span><span class="o">$</span><span class="n">docs.removed</span><span class="p">)</span> <span class="o">%&gt;%</span> 
                                                                           <span class="n">pull</span><span class="p">,</span>
        <span class="n">documents_matrix</span> <span class="o">=</span> <span class="n">docs[[i]]</span><span class="o">$</span><span class="n">documents</span><span class="p">,</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="n">question_names[[i]]</span><span class="p">,</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nf">names</span><span class="p">(</span><span class="n">questions[i]</span><span class="p">),</span>
        <span class="n">clustering_thresh</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="n">instant</span> <span class="o">=</span> <span class="n">datajson</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">T</span><span class="p">,</span>
        <span class="n">topic_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">$</span><span class="n">topics</span><span class="p">,</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">$</span><span class="n">clusters</span><span class="p">,</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="p">)},</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">TRUE</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">+</span> <span class="m">0.1</span>
    <span class="p">})</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="n">break</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Performing hierarchical topic clustering ... 
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

 


    </main>
    